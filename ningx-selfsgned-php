#!/bin/bash

# Hata durumunda betiÄŸi durdur
set -e

# Paketleri gÃ¼ncelle ve gerekli paketleri kur
echo "ðŸ”„ Gerekli paketler yÃ¼kleniyor..."
apt update
apt install -y nginx php-fpm openssl

# Self-signed SSL sertifikasÄ± oluÅŸturuluyor
SSL_DIR="/etc/nginx/ssl"
DOMAIN="localhost"

echo "ðŸ” Self-signed SSL sertifikasÄ± oluÅŸturuluyor..."
mkdir -p $SSL_DIR
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout $SSL_DIR/selfsigned.key \
  -out $SSL_DIR/selfsigned.crt \
  -subj "/C=TR/ST=Istanbul/L=Kadikoy/O=LocalDev/CN=$DOMAIN"

# Nginx yapÄ±landÄ±rmasÄ±
NGINX_CONF="/etc/nginx/sites-available/ssl_site"

echo "ðŸ› ï¸ Nginx yapÄ±landÄ±rma dosyasÄ± oluÅŸturuluyor..."
cat > $NGINX_CONF <<EOF
server {
    listen 3133 ssl;
    server_name $DOMAIN;

    ssl_certificate     $SSL_DIR/selfsigned.crt;
    ssl_certificate_key $SSL_DIR/selfsigned.key;

    root /var/www/html;
    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOF

# Yeni yapÄ±landÄ±rmayÄ± etkinleÅŸtir
ln -sf $NGINX_CONF /etc/nginx/sites-enabled/ssl_site

# VarsayÄ±lan yapÄ±landÄ±rmayÄ± devre dÄ±ÅŸÄ± bÄ±rak
rm -f /etc/nginx/sites-enabled/default

# Nginx yeniden baÅŸlatÄ±lÄ±yor
echo "ðŸ” Nginx yeniden baÅŸlatÄ±lÄ±yor..."
service nginx restart
service php8.2-fpm start
echo "âœ… Kurulum tamamlandÄ±! HTTPS Ã¼zerinden 3133 portunda Ã§alÄ±ÅŸÄ±yor: https://localhost:3133"
